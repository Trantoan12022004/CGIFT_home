// M·∫£ng ch·ª©a th√¥ng tin gi·ªè h√†ng
let cart = [];

// H√†m hi·ªÉn th·ªã s·∫£n ph·∫©m
function displayProducts() {
    const productContainer = document.querySelector(".gifts_section_2 .row");
    if (!productContainer) {
        console.error("Kh√¥ng t√¨m th·∫•y container s·∫£n ph·∫©m");
        return;
    }

    productContainer.innerHTML = "";

    // Hi·ªÉn th·ªã combo tr∆∞·ªõc (s·∫£n ph·∫©m n·ªïi b·∫≠t)
    const combos = products.filter(p => p.category === 'combo');
    const singleProducts = products.filter(p => p.category !== 'combo');

    // Th√™m ti√™u ƒë·ªÅ cho combo
    if (combos.length > 0) {
        productContainer.innerHTML += `
            <div class="col-12">
                <h2 class="section-title">üçπ COMBO M√ôA H√à SI√äU H·∫§P D·∫™N üèñÔ∏è</h2>
            </div>
        `;
        
        combos.forEach((product) => {
            const productHtml = generateProductHTML(product);
            productContainer.innerHTML += productHtml;
        });
    }

    // Th√™m ti√™u ƒë·ªÅ cho s·∫£n ph·∫©m ƒë∆°n l·∫ª
    if (singleProducts.length > 0) {
        productContainer.innerHTML += `
            <div class="col-12">
                <h2 class="section-title">ü•§ ƒê·ªí U·ªêNG & B√ÅNH K·∫∏OSI√äU NGON üç∞</h2>
            </div>
        `;
        
        singleProducts.forEach((product) => {
            const productHtml = generateProductHTML(product);
            productContainer.innerHTML += productHtml;
        });
    }
}

// T·∫°o HTML cho t·ª´ng s·∫£n ph·∫©m
function generateProductHTML(product) {
    const isCombo = product.category === 'combo';
    const popularBadge = product.isPopular ? '<div class="popular-badge">üî• PH·ªî BI·∫æN</div>' : '';
    const discountBadge = product.discount ? `<div class="discount-badge">üí∞ ${product.discount}</div>` : '';
    const originalPriceHTML = product.originalPrice ? 
        `<span class="original-price">~${product.originalPrice.toLocaleString('vi-VN')}ƒë</span>` : '';

    return `
        <div class="col-md-6 col-lg-4" id="product${product.id}">
            <div class="product-card ${isCombo ? 'combo-card' : 'single-card'}">
                ${popularBadge}
                ${discountBadge}
                <div class="product-image">
                    <img src="${product.image}" alt="${product.name}" loading="lazy">
                </div>
                <div class="product-info">
                    <h3 class="product-name">${product.name}</h3>
                    <p class="product-description">${product.description}</p>
                    <div class="price-section">
                        ${originalPriceHTML}
                        <span class="current-price">${product.price.toLocaleString('vi-VN')}ƒë/${product.unit}</span>
                    </div>
                    <div class="order-section">
                        <div class="quantity-input-wrapper">
                            <input type="number" id="${product.quantityInputId}" class="quantity-input" min="1" max="50" placeholder="SL" value="1">
                        </div>
                        <button class="order-btn ${isCombo ? 'combo-btn' : 'single-btn'}" onclick="addToCartSimple(${product.id})">
                            <span class="btn-text">Th√™m v√†o gi·ªè</span>
                            <span class="btn-icon">üõí</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Th√™m s·∫£n ph·∫©m ƒë∆°n gi·∫£n v√†o gi·ªè h√†ng
function addToCartSimple(productId) {
    const product = products.find((p) => p.id === productId);
    const quantityInput = document.getElementById(product.quantityInputId);
    const quantity = parseInt(quantityInput.value) || 1;

    if (quantity > 0 && quantity <= 50) {
        // Ki·ªÉm tra xem s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
        const existingItem = cart.find(item => item.productId === productId);
        
        if (existingItem) {
            existingItem.quantity += quantity;
            existingItem.totalPrice = existingItem.price * existingItem.quantity;
            showNotification(`üîÑ ƒê√£ c·∫≠p nh·∫≠t ${product.name} trong gi·ªè h√†ng!`);
        } else {
            cart.push({
                productId: productId,
                productName: product.name,
                price: product.price,
                quantity: quantity,
                totalPrice: product.price * quantity,
            });
            showNotification(`‚úÖ ƒê√£ th√™m ${product.name} v√†o gi·ªè h√†ng!`);
        }

        // Hi·ªáu ·ª©ng th√™m v√†o gi·ªè h√†ng
        showAddToCartAnimation(productId);
        
        // Reset input
        quantityInput.value = "1";
        
        updatePaymentForm();
        
        // Cu·ªôn ƒë·∫øn ph·∫ßn thanh to√°n sau 1 gi√¢y
        setTimeout(() => {
            document.getElementById('thanhtoan').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }, 800);
    } else {
        showNotification("‚ö†Ô∏è S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá (1-50)!");
    }
}

// Hi·ªáu ·ª©ng th√™m v√†o gi·ªè h√†ng
function showAddToCartAnimation(productId) {
    const productCard = document.getElementById(`product${productId}`);
    if (productCard) {
        productCard.classList.add('added-to-cart');
        setTimeout(() => {
            productCard.classList.remove('added-to-cart');
        }, 1200);
    }
}

// Hi·ªÉn th·ªã th√¥ng b√°o
function showNotification(message) {
    // T·∫°o th√¥ng b√°o n·∫øu ch∆∞a c√≥
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = 'notification';
        document.body.appendChild(notification);
    }
    
    notification.innerHTML = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

// C·∫≠p nh·∫≠t form thanh to√°n
function updatePaymentForm() {
    let cartItemsList = document.getElementById("cartItems");
    let totalAmount = 0;

    if (!cartItemsList) {
        console.error("Kh√¥ng t√¨m th·∫•y element cartItems");
        return;
    }

    if (cart.length === 0) {
        cartItemsList.innerHTML = '<li style="text-align: center; color: #999; font-style: italic;">üõí Gi·ªè h√†ng tr·ªëng</li>';
        const totalAmountInput = document.getElementById("totalAmount");
        if (totalAmountInput) {
            totalAmountInput.value = "0 VND";
        }
        return;
    }

    cartItemsList.innerHTML = "";

    cart.forEach((item, index) => {
        let listItem = document.createElement("li");
        listItem.className = "cart-item";
        listItem.innerHTML = `
            <div class="cart-item-info">
                <span class="item-name">üçΩÔ∏è ${item.productName}</span>
                <span class="item-details">S·ªë l∆∞·ª£ng: ${item.quantity} | ƒê∆°n gi√°: ${item.price.toLocaleString('vi-VN')}ƒë</span>
                <span class="item-total">Th√†nh ti·ªÅn: ${item.totalPrice.toLocaleString('vi-VN')}ƒë</span>
            </div>
            <button class="remove-item" onclick="removeFromCart(${index})" title="X√≥a s·∫£n ph·∫©m">üóëÔ∏è</button>
        `;
        cartItemsList.appendChild(listItem);
        totalAmount += item.totalPrice;
    });

    const totalAmountInput = document.getElementById("totalAmount");
    if (totalAmountInput) {
        totalAmountInput.value = totalAmount.toLocaleString('vi-VN') + " VND";
    }
    
    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè h√†ng
    updateCartCount();
}

// X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng
function removeFromCart(index) {
    const removedItem = cart[index];
    cart.splice(index, 1);
    updatePaymentForm();
    showNotification(`üóëÔ∏è ƒê√£ x√≥a ${removedItem.productName} kh·ªèi gi·ªè h√†ng!`);
}

// C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè h√†ng
function updateCartCount() {
    const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
    
    // T√¨m ho·∫∑c t·∫°o badge hi·ªÉn th·ªã s·ªë l∆∞·ª£ng
    let cartBadge = document.getElementById('cart-badge');
    if (!cartBadge && cartCount > 0) {
        cartBadge = document.createElement('span');
        cartBadge.id = 'cart-badge';
        cartBadge.className = 'cart-badge';
        cartBadge.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--summer-gradient);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px rgba(255,107,53,0.4);
            z-index: 1000;
        `;
        document.body.appendChild(cartBadge);
    }
    
    if (cartBadge) {
        if (cartCount > 0) {
            cartBadge.textContent = cartCount;
            cartBadge.style.display = 'flex';
        } else {
            cartBadge.style.display = 'none';
        }
    }
}

// G·ª≠i ƒë∆°n h√†ng
function submitOrder() {
    if (cart.length === 0) {
        showNotification("‚ö†Ô∏è Gi·ªè h√†ng tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.");
        return;
    }

    let cartItemsString = "";

    cart.forEach((item, index) => {
        cartItemsString += `S·∫£n ph·∫©m ${index + 1}: ${item.productName}, S·ªë l∆∞·ª£ng: ${
            item.quantity
        }, Gi√°: ${item.price.toLocaleString('vi-VN')} VND, T·ªïng: ${item.totalPrice.toLocaleString('vi-VN')} VND; `;
    });

    const fullName = document.getElementById("fullName").value;
    const phone = document.getElementById("phone").value;
    const address = document.getElementById("address").value;
    const paymentMethod = document.getElementById("paymentMethod").value;
    const totalAmount = document.getElementById("totalAmount").value;
    const note = document.getElementById("note").value;

    // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
    if (!fullName || !phone || !address || !paymentMethod) {
        showNotification("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
        return;
    }

    let submitButton = document.querySelector('.submit-btn');
    if (submitButton.disabled) {
        return;
    }
    submitButton.disabled = true;
    submitButton.innerHTML = "üåÄ ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng...";

    const orderData = {
        fullName: fullName,
        phone: phone,
        address: address,
        paymentMethod: paymentMethod,
        totalAmount: totalAmount,
        note: note,
        cartItems: cartItemsString,
    };

    fetch("https://script.google.com/macros/s/AKfycbwjDuSDUSxafLTGlOygvJkLAzbX-tyNVSCKaIOGqG6vD7QLpdaX33kTNgG2R7b5nz-pMQ/exec", {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(orderData),
        headers: {
            "Content-Type": "application/json",
        },
    })
        .then((data) => {
            showNotification("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ tin t∆∞·ªüng ch√∫ng t√¥i!");
            // Reset form v√† gi·ªè h√†ng
            cart = [];
            document.getElementById("paymentForm").reset();
            updatePaymentForm();
            submitButton.disabled = false;
            submitButton.innerHTML = "üåû X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG M√ôA H√à üåä";
        })
        .catch((error) => {
            console.error("L·ªói:", error);
            showNotification("‚ùå C√≥ l·ªói x·∫£y ra! Vui l√≤ng th·ª≠ l·∫°i sau.");
            submitButton.disabled = false;
            submitButton.innerHTML = "üåû X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG M√ôA H√à üåä";
        });
}

// Kh·ªüi t·∫°o khi trang load
document.addEventListener("DOMContentLoaded", function () {
    // Ki·ªÉm tra xem products ƒë√£ ƒë∆∞·ª£c load ch∆∞a
    if (typeof products !== "undefined") {
        console.log("Products loaded:", products);
        displayProducts();
    } else {
        console.error("Products not loaded");
        // Th·ª≠ load l·∫°i sau 100ms
        setTimeout(() => {
            if (typeof products !== "undefined") {
                displayProducts();
            } else {
                console.error("Products still not loaded after retry");
            }
        }, 100);
    }
});
